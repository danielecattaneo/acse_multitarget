target ?= mace
bindir = ../bin
project = $(bindir)/acse
BISON ?= bison
FLEX ?= flex
override CFLAGS +=
override LDFLAGS +=
override YFLAGS +=
override LFLAGS +=

objdir = ./obj
override CFLAGS += -I$(objdir) -I./$(target) -I.

y_src = Acse.y
lex_src = Acse.lex
c_src = $(wildcard *.c) $(wildcard $(target)/*.c)
derived_c_src = $(objdir)/Acse.tab.c $(objdir)/lex.yy.c
version_c = $(objdir)/axe_version.c

c_objects = $(patsubst %, $(objdir)/%, $(notdir $(c_src:.c=.o)))
object = $(c_objects) $(derived_c_src:.c=.o) $(version_c:.c=.o)
deps = $(object:.o=.d)

.PHONY: all clean

all: $(project)

-include $(deps)

$(project): $(object) $(bindir)
	$(CC) $(LDFLAGS) $(object) -o $@

$(objdir)/%.o: %.c
	$(CC) $(CFLAGS) -MMD -c $< -o $@

$(objdir)/%.o: $(target)/%.c
	$(CC) $(CFLAGS) -MMD -c $< -o $@

$(objdir)/lex.yy.c: Acse.lex $(objdir)/Acse.tab.h
	$(FLEX) $(LFLAGS) -o $@ $<

# This rule keeps Make happy, while the %.tab.h file is generated by
#  the bison rule above
$(objdir)/%.tab.h: $(objdir)/%.tab.c
	if [ -e $@ ]; then touch $@; else false; fi

$(objdir)/Acse.tab.c: Acse.y
	$(BISON) $(YFLAGS) -o $@ -d $< 

$(version_c): ../VERSION
	printf 'const char *axe_version = "%s";\n' `cat $<` > $@

$(version_c): | $(objdir)
$(derived_c_src): | $(objdir)
$(object): | $(objdir)

$(objdir):
	mkdir -p $@

$(bindir):
	mkdir -p $@

clean:
	rm -rf $(objdir)
	rm -f Acse.tab.c Acse.tab.h lex.yy.c $(project) $(project:=.exe)
